<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–°åŠ å¡èŠ±åœ’ä¹‹æ—… ğŸ¦</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+TC:wght@400;700&family=Patrick+Hand&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        display: ['"Fredoka"', 'sans-serif'],
                        hand: ['"Patrick Hand"', 'cursive'],
                    },
                    colors: {
                        // æ–°åŠ å¡ä¸»é¡Œè‰²ï¼šç¿ ç¶ èˆ‡ç†±å¸¶è—
                        tropical: { 50: '#f0fdf4', 100: '#dcfce7', 500: '#10b981', 600: '#059669' },
                        // åˆ†å¸³å°ˆç”¨è‰²
                        p0: '#14b8a6', p1: '#f472b6', p2: '#8b5cf6', p3: '#f59e0b', p4: '#3b82f6'
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'wiggle': 'wiggle 3s ease-in-out infinite',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        fadeInUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        wiggle: { '0%, 100%': { transform: 'rotate(-3deg)' }, '50%': { transform: 'rotate(3deg)' } },
                        pop: { '0%': { transform: 'scale(0.9)' }, '50%': { transform: 'scale(1.05)' }, '100%': { transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f0fdfa; -webkit-tap-highlight-color: transparent; padding-bottom: 120px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .tropical-blob { position: absolute; filter: blur(60px); z-index: 0; opacity: 0.4; animation: float 10s ease-in-out infinite; }
        
        /* åº•éƒ¨å°èˆª */
        .nav-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);
            border-radius: 2rem; padding: 0.5rem 1rem; display: flex; gap: 1rem;
            z-index: 100; box-shadow: 0 10px 30px -5px rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(255,255,255,0.8);
            width: 90%; max-width: 400px; justify-content: space-around;
        }
        .nav-item {
            display: flex; flex-col; align-items: center; justify-content: center;
            color: #94a3b8; transition: all 0.3s; cursor: pointer; flex: 1;
        }
        .nav-item.active { color: #10b981; transform: translateY(-4px); }
        .nav-icon { font-size: 1.5rem; margin-bottom: 2px; }
        .nav-label { font-size: 0.7rem; font-weight: bold; font-family: 'Fredoka'; }

        /* åˆ†å¸³ UI */
        .split-input { width: 100%; border: 2px solid #6ee7b7; border-radius: 12px; padding: 10px; font-family: 'Fredoka'; outline: none; transition: all 0.2s; background: #fff; }
        .split-input:focus { border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
        
        .avatar-option { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; cursor: pointer; transition: all 0.2s; border: 3px solid transparent; opacity: 0.6; transform: scale(0.9); }
        .avatar-option.selected { opacity: 1; transform: scale(1.15); box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2); border-color: white; outline: 2px solid #10b981; }
        
        .av-0 { background: #14b8a6; } .av-1 { background: #f472b6; } .av-2 { background: #8b5cf6; } .av-3 { background: #f59e0b; } .av-4 { background: #3b82f6; }

        .target-chip { padding: 6px 14px; border-radius: 20px; border: 2px solid #e5e7eb; color: #9ca3af; font-size: 0.9rem; font-weight: bold; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; font-family: 'Fredoka'; }
        .target-chip.active { background: #f0fdf4; border-color: #10b981; color: #10b981; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(16, 185, 129, 0.1); }
        .target-chip.active .check-dot { background: #10b981; transform: scale(1.2); }
        .check-dot { width: 8px; height: 8px; border-radius: 50%; background: #e5e7eb; transition: all 0.2s; }

        .expense-card { background: white; border-radius: 16px; padding: 14px; margin-bottom: 12px; border: 1px solid #f0fdf4; box-shadow: 0 2px 4px rgba(0,0,0,0.02); display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden; }
        .expense-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; }
        .expense-card.payer-0::before { background: #14b8a6; } .expense-card.payer-1::before { background: #f472b6; } .expense-card.payer-2::before { background: #8b5cf6; }

        /* å¡ç‰‡ */
        .polaroid-card { background: white; padding: 10px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; transition: all 0.3s; }
        .polaroid-card:hover { transform: scale(1.02) rotate(1deg) !important; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 10; }
        
        .journal-card { background: white; border-radius: 1rem; box-shadow: 2px 4px 12px rgba(0,0,0,0.03); border: 1px solid rgba(255,255,255,0.8); position: relative; transition: transform 0.3s; }
        .journal-card:hover { transform: translateY(-3px); box-shadow: 4px 8px 20px rgba(16, 185, 129, 0.15); }

        .washi-tape { position: absolute; top: -10px; left: 50%; transform: translateX(-50%) rotate(-2deg); width: 80px; height: 18px; background-color: rgba(52, 211, 153, 0.4); box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 10; opacity: 0.9; }
        .sticker { position: absolute; z-index: 20; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); }
        .timeline-line { position: absolute; left: 24px; top: 20px; bottom: 0; width: 2px; background-image: linear-gradient(to bottom, #6ee7b7 50%, transparent 50%); background-size: 2px 10px; z-index: 0; }
        
        .btn-instagram { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .check-item.checked { text-decoration: line-through; color: #d6d3d1; opacity: 0.7; }
        .check-item.checked .check-box { background-color: #10b981; border-color: #10b981; color:white; }
        .check-box { width: 20px; height: 20px; border: 2px solid #6ee7b7; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-right: 12px; }
    </style>
</head>
<body class="text-slate-600 antialiased selection:bg-emerald-100 selection:text-emerald-900">

    <div class="fixed inset-0 z-0 pointer-events-none">
        <div class="tropical-blob w-96 h-96 bg-emerald-100 rounded-full top-0 left-0 -translate-x-1/2 -translate-y-1/2"></div>
        <div class="tropical-blob w-80 h-80 bg-teal-100 rounded-full bottom-0 right-0 translate-x-1/3 translate-y-1/3" style="animation-delay: 2s;"></div>
    </div>

    <div class="relative z-10 max-w-lg mx-auto px-6 py-8">
        <a href="../" class="absolute top-6 left-6 w-10 h-10 flex items-center justify-center bg-white/60 backdrop-blur rounded-full shadow-sm text-slate-500 hover:scale-110 transition-transform z-20">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
        </a>

        <div class="text-center mt-12 mb-8 relative">
            <span class="sticker -top-6 -right-2 text-4xl animate-wiggle" style="animation-delay: 1s;">ğŸ¦</span>
            <div class="inline-block bg-emerald-100/60 px-4 py-1 rounded-full border border-emerald-200 mb-3">
                <span class="text-xs font-bold text-emerald-700 tracking-widest font-display">SINGAPORE 2025</span>
            </div>
            <h1 class="text-4xl font-display font-bold text-slate-800 mb-2 tracking-tight">æ–°åŠ å¡<br><span class="text-emerald-500 font-hand text-5xl">èŠ±åœ’ä¹‹æ—…</span></h1>
            <div id="countdown-timer" class="text-slate-400 text-sm font-hand mt-2 bg-white/50 inline-block px-3 py-1 rounded-lg backdrop-blur-sm border border-white">è¨ˆç®—ä¸­...</div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="bg-white/70 backdrop-blur rounded-2xl p-4 shadow-sm border border-white relative transform -rotate-1 hover:rotate-0 transition-transform cursor-pointer group" onclick="toggleConverter()">
                <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-16 h-4 bg-emerald-200/50 rotate-2"></div>
                <div id="cost-view">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 font-display group-hover:text-emerald-500 transition-colors">ESTIMATED â†»</p>
                    <div class="flex items-baseline gap-1"><span class="text-sm font-light opacity-60">$</span><span id="total-budget" class="text-2xl font-bold text-slate-700 font-display">0</span></div>
                </div>
                <div id="converter-view" class="hidden">
                    <p class="text-[10px] font-bold text-emerald-500 uppercase tracking-wider mb-1 font-display">SGD to TWD</p>
                    <div class="flex items-center gap-1"><span class="text-sm text-slate-400 font-hand">S$</span><input type="number" id="jpy-input" class="w-full bg-transparent border-b border-slate-300 text-xl font-bold text-slate-700 focus:outline-none focus:border-emerald-400" placeholder="0" onclick="event.stopPropagation()"></div>
                    <div class="text-right mt-1 text-xs text-slate-500 font-hand">â‰ˆ $<span id="twd-output">0</span></div>
                </div>
            </div>
            
            <div class="bg-white/70 backdrop-blur rounded-2xl p-4 shadow-sm border border-white relative transform rotate-1 flex flex-col items-center justify-center">
                <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-16 h-4 bg-teal-200/50 -rotate-2"></div>
                <div id="weather-display" class="flex flex-col items-center"><span id="weather-icon" class="text-3xl mb-1">ğŸŒ¤ï¸</span><div class="flex items-baseline gap-1"><span id="weather-temp" class="text-2xl font-bold text-slate-700 font-display">--</span><span class="text-xs text-slate-400">Â°C</span></div></div>
            </div>
        </div>
    </div>

    <div class="max-w-xl mx-auto px-4 relative z-20">
        
        <div id="view-schedule" class="view-section">
            <div id="sticky-header" class="sticky top-4 z-30 mb-6 transition-all duration-300">
                <div class="bg-white/80 backdrop-blur-md shadow-sm rounded-2xl p-1.5 border border-white/50">
                    <div class="flex overflow-x-auto hide-scrollbar gap-1.5" id="day-tabs"></div>
                    <div class="flex overflow-x-auto hide-scrollbar gap-1.5 hidden" id="category-tabs"></div>
                </div>
            </div>
            <div id="route-btn-container" class="mb-6 hidden animate-fade-in-up px-2">
                <button onclick="openDayRoute()" class="w-full bg-white/90 border-2 border-dashed border-emerald-200 text-emerald-600 font-bold py-3 rounded-xl shadow-sm hover:bg-emerald-50 transition-all flex items-center justify-center gap-2 font-display"><span>ğŸ—ºï¸</span> é–‹å•Ÿä»Šæ—¥è·¯ç·šå°èˆª</button>
            </div>
            <div class="relative min-h-[400px]">
                <div id="timeline-line" class="timeline-line transition-opacity duration-300"></div>
                <div id="schedule-list" class="space-y-6 relative z-10 pb-10"></div>
            </div>
        </div>

        <div id="view-split" class="view-section hidden animate-fade-in-up">
            <div id="family-settings" class="bg-white rounded-2xl p-5 mb-4 shadow-lg border border-slate-200 hidden fixed top-20 left-4 right-4 z-50 animate-pop">
                <div class="flex justify-between items-center mb-4"><h4 class="font-bold text-slate-700">è¨­å®š</h4><button onclick="toggleSettings()" class="text-slate-400 p-2">âœ•</button></div>
                <div class="mb-4 pb-4 border-b border-slate-100">
                    <p class="text-xs text-slate-400 font-bold mb-1">ç›®å‰åŒ¯ç‡ (SGD â†’ TWD)</p>
                    <input type="number" id="settings-rate" class="split-input text-sm" value="24.7" onchange="updateRate()">
                </div>
                <p class="text-xs text-slate-400 font-bold mb-2">æ–°å¢æˆå“¡</p>
                <div class="flex gap-2 mb-4"><input type="text" id="new-family-name" class="split-input text-sm" placeholder="è¼¸å…¥åå­—"><button onclick="addFamily()" class="bg-slate-800 text-white px-4 rounded-lg text-sm font-bold whitespace-nowrap">æ–°å¢</button></div>
                <div id="family-list-container" class="flex flex-wrap gap-2 mb-4"></div>
                <button onclick="resetAllSplitData()" class="w-full py-2 bg-red-50 text-red-500 text-xs rounded-lg font-bold">âš ï¸ é‡ç½®è³‡æ–™</button>
            </div>
            <div id="settings-overlay" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-40 hidden" onclick="toggleSettings()"></div>

            <div class="bg-slate-800 text-white rounded-3xl p-6 mb-6 shadow-xl relative overflow-hidden">
                <div class="absolute right-4 top-4 text-xs font-bold bg-white/10 px-3 py-1.5 rounded-full cursor-pointer hover:bg-white/20 transition-colors" onclick="toggleSettings()">âš™ï¸ è¨­å®š</div>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Total Pool</h3>
                <div class="text-3xl font-bold font-mono mb-4">NT$ <span id="split-total">0</span></div>
                <div id="balance-container" class="space-y-3"></div>
                <div id="settlement-plan" class="mt-4 pt-3 border-t border-white/10 text-xs text-emerald-200 font-mono leading-relaxed">æš«ç„¡å¸³ç›®</div>
            </div>

            <div class="bg-white rounded-2xl p-5 shadow-sm border border-emerald-100 mb-6">
                <h4 class="font-bold text-slate-700 mb-4 font-display text-center text-lg">Add Expense</h4>
                <p class="text-xs font-bold text-slate-400 mb-2 ml-1">èª°å…ˆå¢ŠéŒ¢?</p>
                <div id="payer-selector" class="flex gap-3 justify-start mb-4 overflow-x-auto pb-2"></div>
                <div class="flex gap-2 mb-4">
                    <select id="split-currency" class="bg-emerald-50 border border-emerald-200 text-emerald-600 font-bold rounded-xl px-3 text-sm outline-none">
                        <option value="TWD">TWD ($)</option>
                        <option value="SGD" selected>SGD (S$)</option>
                    </select>
                    <input type="number" id="split-amount" class="split-input flex-1 text-lg font-bold text-slate-700" placeholder="é‡‘é¡">
                </div>
                <input type="text" id="split-note" class="split-input mb-4" placeholder="é …ç›® (å¦‚: çå¯¶æµ·é®®)">
                <p class="text-xs font-bold text-slate-400 mb-2 ml-1">åˆ†çµ¦èª°?</p>
                <div id="split-targets" class="flex flex-wrap gap-2 mb-6"></div>
                <button onclick="addExpense()" class="w-full bg-emerald-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-emerald-200 hover:bg-emerald-600 active:scale-95 transition-all font-display tracking-widest">ï¼‹ åŠ å…¥è¨˜å¸³</button>
            </div>

            <h4 class="font-bold text-slate-400 text-xs uppercase mb-3 ml-2 tracking-widest">History</h4>
            <div id="split-history" class="space-y-3 pb-10"></div>
        </div>

        <div id="view-packing" class="view-section hidden animate-fade-in-up">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-emerald-50 relative">
                <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-32 h-6 bg-emerald-200/50 rotate-1"></div>
                <h3 class="text-xl font-bold text-slate-700 font-display mb-4 text-center">Packing List ğŸ§³</h3>
                <div id="packing-list-container" class="space-y-3 font-hand text-lg"></div>
                <button onclick="resetPacking()" class="mt-6 w-full py-2 text-xs text-slate-400 hover:text-emerald-500 text-center">é‡ç½®æ¸…å–®</button>
            </div>
        </div>

        <div id="view-japanese" class="view-section hidden animate-fade-in-up">
            <h3 class="text-center font-display text-xl font-bold text-slate-700 mb-6">Survival English ğŸ‡¸ğŸ‡¬</h3>
            <div class="grid grid-cols-2 gap-4" id="jp-card-container"></div>
        </div>
    </div>

    <div class="nav-bar">
        <div onclick="switchView('schedule')" class="nav-item active" id="nav-schedule"><div class="nav-icon">ğŸ“…</div><div class="nav-label">è¡Œç¨‹</div></div>
        <div onclick="switchView('list')" class="nav-item" id="nav-list"><div class="nav-icon">ğŸ“</div><div class="nav-label">æ¸…å–®</div></div>
        <div onclick="switchView('split')" class="nav-item" id="nav-split"><div class="nav-icon">ğŸ’°</div><div class="nav-label">åˆ†å¸³</div></div>
        <div onclick="switchView('packing')" class="nav-item" id="nav-packing"><div class="nav-icon">ğŸ§³</div><div class="nav-label">è¡Œæ</div></div>
        <div onclick="switchView('japanese')" class="nav-item" id="nav-japanese"><div class="nav-icon">ğŸ—£ï¸</div><div class="nav-label">è‹±æ–‡</div></div>
    </div>

    <script>
        // ã€è«‹è²¼ä¸Šæ‚¨æ–°åŠ å¡ Sheet çš„ CSV é€£çµã€‘
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT0VzpYNtRMmLw1A39zZtqT4mRAyUpZynYsd_CxtmqYWzC7kXjs-S6Kam7cEPkU3wcK6SlFO1yYwx-O/pub?gid=1477692299&single=true&output=csv';

        let currentView = 'schedule';
        let currentDayIndex = 0;
        let rawData = [], scheduleData = [], listData = new Map();

        // å¤æ—¥/ç†±å¸¶è¡Œææ¸…å–®
        const defaultPacking = [
            "è­·ç…§ (Passport)", "ç¶²å¡ / Wi-Fi æ©Ÿ", "æ–°åŠ å¡å¹£ / ä¿¡ç”¨å¡", 
            "å¤å­£è¡£ç‰© / æ³³è¡£", "è–„å¤–å¥— (å®¤å…§å†·æ°£)", "é›¨å‚˜ / è¼•ä¾¿é›¨è¡£", "é˜²èšŠæ¶² / è—¥è†",
            "é˜²æ›¬ä¹³ / å¢¨é¡", "å€‹äººè—¥å“", "è½‰æ¥é ­ (è‹±å¼ä¸‰å­”)"
        ];
        // æ–°åŠ å¡å¯¦ç”¨è‹±æ–‡
        const jpCards = [
            { ch: "é€™å€‹å¤šå°‘éŒ¢?", jp: "How much is this?", ro: "" },
            { ch: "å¯ä»¥åˆ·å¡å—?", jp: "Can I pay by card?", ro: "PayWave / Apple Pay" },
            { ch: "é€™æœƒè¾£å—?", jp: "Is this spicy?", ro: "" },
            { ch: "å»æ‰€åœ¨å“ªè£¡?", jp: "Where is the toilet?", ro: "" },
            { ch: "æˆ‘è¦ä¸€æ¯å†°å’–å•¡", jp: "I want a Kopi Peng.", ro: "Kopi-O (é»‘å’–å•¡) / Teh (å¥¶èŒ¶)" },
            { ch: "è¬è¬", jp: "Thank you!", ro: "Terima Kasih (é¦¬ä¾†èª)" }
        ];

        // å…¨åŸŸåŒ¯ç‡ (SGD)
        let EXCHANGE_RATE = parseFloat(localStorage.getItem('sg_rate') || 24.7);

        window.onload = function() { 
            fetchData(); initWeather(); renderPackingList(); renderJapaneseCards();
            try { initSplitSystem(); } catch(e) { console.error(e); resetAllSplitData(); }
            document.getElementById('settings-rate').value = EXCHANGE_RATE;
        };

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${view}`).classList.add('active');
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));

            if(view === 'schedule') {
                document.getElementById('view-schedule').classList.remove('hidden');
                document.getElementById('day-tabs').classList.remove('hidden');
                document.getElementById('category-tabs').classList.add('hidden');
                document.getElementById('timeline-line').style.opacity = '1';
                document.getElementById('route-btn-container').classList.remove('hidden');
                renderScheduleMode();
            } else if (view === 'list') {
                document.getElementById('view-schedule').classList.remove('hidden');
                document.getElementById('day-tabs').classList.add('hidden');
                document.getElementById('category-tabs').classList.remove('hidden');
                document.getElementById('timeline-line').style.opacity = '0';
                document.getElementById('route-btn-container').classList.add('hidden');
                renderListMode();
            } else if (view === 'split') {
                document.getElementById('view-split').classList.remove('hidden');
                updateSplitUI();
            } else {
                document.getElementById(`view-${view}`).classList.remove('hidden');
            }
        }

        // ==========================================
        //  åˆ†å¸³ç³»çµ± (Singapore ç¨ç«‹è³‡æ–™)
        // ==========================================
        let families = [];
        let expenses = [];
        let selectedPayer = "";

        function initSplitSystem() {
            try { families = JSON.parse(localStorage.getItem('sg_families')); } catch(e) { families = null; }
            if (!families || !Array.isArray(families) || families.length === 0) {
                families = ["Rex", "Abby"]; localStorage.setItem('sg_families', JSON.stringify(families));
            }
            try { expenses = JSON.parse(localStorage.getItem('sg_expenses')); } catch(e) { expenses = null; }
            if (!expenses) { expenses = []; localStorage.setItem('sg_expenses', JSON.stringify(expenses)); }

            selectedPayer = families[0];
            updateSplitUI();
        }

        function updateRate() {
            const newRate = parseFloat(document.getElementById('settings-rate').value);
            if(newRate > 0) {
                EXCHANGE_RATE = newRate;
                localStorage.setItem('sg_rate', newRate);
                calculateBalances(); 
                alert("åŒ¯ç‡å·²æ›´æ–°");
            }
        }

        function toggleSettings() {
            document.getElementById('family-settings').classList.toggle('hidden');
            document.getElementById('settings-overlay').classList.toggle('hidden');
        }

        function addFamily() {
            const name = document.getElementById('new-family-name').value.trim();
            if(name && !families.includes(name)) {
                families.push(name);
                localStorage.setItem('sg_families', JSON.stringify(families));
                document.getElementById('new-family-name').value = '';
                updateSplitUI();
            }
        }

        function removeFamily(name) {
            if(confirm(`ç§»é™¤ ${name}ï¼Ÿ`)) {
                families = families.filter(f => f !== name);
                localStorage.setItem('sg_families', JSON.stringify(families));
                if(selectedPayer === name) selectedPayer = families[0] || "";
                updateSplitUI();
            }
        }

        function resetAllSplitData() {
            if(confirm("âš ï¸ åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ")) {
                localStorage.removeItem('sg_families'); localStorage.removeItem('sg_expenses');
                initSplitSystem(); toggleSettings();
            }
        }

        function setPayer(name) { selectedPayer = name; updateSplitUI(); }

        function updateSplitUI() {
            document.getElementById('family-list-container').innerHTML = families.map(f => 
                `<span class="px-3 py-1 bg-stone-100 rounded-full text-xs font-bold text-stone-600 cursor-pointer hover:bg-red-100 hover:text-red-500" onclick="removeFamily('${f}')">${f} Ã—</span>`
            ).join('');

            const payerContainer = document.getElementById('payer-selector');
            if(families.length > 0 && !families.includes(selectedPayer)) selectedPayer = families[0];
            
            payerContainer.innerHTML = families.map((f, i) => {
                const isSelected = f === selectedPayer ? 'selected' : '';
                const colorClass = `av-${i % 5}`; 
                return `<div class="avatar-option ${colorClass} ${isSelected}" onclick="setPayer('${f}')">${f[0]}</div>`;
            }).join('');

            const targetsContainer = document.getElementById('split-targets');
            if (targetsContainer.innerHTML.trim() === '' || targetsContainer.children.length !== families.length) {
                 targetsContainer.innerHTML = families.map(f => `
                    <div class="target-chip active" onclick="this.classList.toggle('active')" data-family="${f}">
                        <div class="check-dot"></div> ${f}
                    </div>
                `).join('');
            }

            renderExpenseList();
            calculateBalances();
        }

        function addExpense() {
            const amountInput = document.getElementById('split-amount').value;
            const note = document.getElementById('split-note').value;
            const currency = document.getElementById('split-currency').value;
            const amount = parseFloat(amountInput);
            const involved = [];
            document.querySelectorAll('#split-targets .target-chip.active').forEach(el => involved.push(el.getAttribute('data-family')));

            if(!amount || !note || involved.length === 0) { alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™"); return; }

            expenses.unshift({ 
                id: Date.now(), payer: selectedPayer, amount: amount, currency: currency, 
                note, involved, date: new Date().toLocaleDateString() 
            });
            localStorage.setItem('sg_expenses', JSON.stringify(expenses));
            
            document.getElementById('split-amount').value = '';
            document.getElementById('split-note').value = '';
            renderExpenseList();
            calculateBalances();
        }

        function deleteExpense(id) {
            if(!confirm("åˆªé™¤ï¼Ÿ")) return;
            expenses = expenses.filter(e => e.id !== id);
            localStorage.setItem('sg_expenses', JSON.stringify(expenses));
            renderExpenseList();
            calculateBalances();
        }

        function renderExpenseList() {
            const list = document.getElementById('split-history');
            list.innerHTML = expenses.map(e => {
                const colorIdx = families.indexOf(e.payer) % 5; 
                const bgClass = `payer-${colorIdx >= 0 ? colorIdx : 0}`; 
                const avatarBg = `av-${colorIdx >= 0 ? colorIdx : 0}`;
                const symbol = e.currency === 'SGD' ? 'S$' : '$';
                let subText = "";
                if(e.currency === 'SGD') {
                    const twdVal = Math.round(e.amount * EXCHANGE_RATE);
                    subText = `<div class="text-[10px] text-stone-300 text-right">â‰ˆ $${twdVal}</div>`;
                }

                return `
                <div class="expense-card ${bgClass} animate-pop">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full ${avatarBg} text-white flex items-center justify-center text-sm font-bold shadow-sm">${e.payer[0]}</div>
                        <div>
                            <div class="font-bold text-stone-700 text-sm">${e.note}</div>
                            <div class="text-[10px] text-stone-400">åˆ†çµ¦: ${e.involved.length === families.length ? 'æ‰€æœ‰äºº' : e.involved.join(', ')}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="text-right"><span class="font-mono font-bold text-stone-600 text-lg">${symbol}${e.amount}</span>${subText}</div>
                        <button onclick="deleteExpense(${e.id})" class="text-stone-300 hover:text-red-400 text-xl font-bold">Ã—</button>
                    </div>
                </div>`;
            }).join('');
        }

        function calculateBalances() {
            let totalTWD = 0;
            let balances = {}; 
            families.forEach(f => balances[f] = 0);

            expenses.forEach(e => {
                let amountTWD = e.amount;
                if (e.currency === 'SGD') amountTWD = Math.round(e.amount * EXCHANGE_RATE);

                totalTWD += amountTWD;
                if(balances[e.payer] !== undefined) balances[e.payer] += amountTWD;
                
                const share = amountTWD / e.involved.length;
                e.involved.forEach(fam => {
                    if(balances[fam] !== undefined) balances[fam] -= share;
                });
            });

            document.getElementById('split-total').innerText = totalTWD.toLocaleString();
            
            const container = document.getElementById('balance-container');
            container.innerHTML = Object.keys(balances).map((f, i) => {
                const val = balances[f];
                const maxBar = totalTWD > 0 ? totalTWD : 100; 
                const percent = Math.min(Math.abs(val) / maxBar * 100 * 2.5, 100); 
                const colorClass = `av-${i % 5}`;
                const moneyColor = val >= 0 ? 'text-green-300' : 'text-red-300';
                
                return `<div class="flex items-center gap-2 text-xs"><div class="w-8 font-bold text-slate-300 truncate">${f}</div><div class="flex-1 bg-white/10 h-2 rounded-full overflow-hidden flex ${val < 0 ? 'justify-start' : 'justify-end'}"><div class="h-full rounded-full opacity-80 ${colorClass}" style="width: ${percent}%; min-width: 2px;"></div></div><div class="w-16 text-right font-mono ${moneyColor}">${val >= 0 ? '+' : ''}${Math.round(val)}</div></div>`;
            }).join('');

            let debtors = [], creditors = [];
            for (let f in balances) {
                if (balances[f] < -1) debtors.push({ name: f, amount: balances[f] });
                else if (balances[f] > 1) creditors.push({ name: f, amount: balances[f] });
            }
            debtors.sort((a, b) => a.amount - b.amount); creditors.sort((a, b) => b.amount - a.amount);

            let steps = [];
            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                let debt = Math.abs(debtors[i].amount);
                let credit = creditors[j].amount;
                let pay = Math.min(debt, credit);
                if (pay > 0) steps.push(`<span class="text-white">${debtors[i].name}</span> çµ¦ <span class="text-white">${creditors[j].name}</span> <span class="text-yellow-300 font-bold">$${Math.round(pay)}</span>`);
                debtors[i].amount += pay; creditors[j].amount -= pay;
                if (Math.abs(debtors[i].amount) < 1) i++;
                if (creditors[j].amount < 1) j++;
            }
            document.getElementById('settlement-plan').innerHTML = steps.length > 0 ? steps.join('<br>') : "ç›®å‰å¸³ç›®å·²å¹³ï¼";
        }

        function renderPackingList() {
            const container = document.getElementById('packing-list-container');
            const savedData = JSON.parse(localStorage.getItem('packing_sg') || '{}');
            container.innerHTML = defaultPacking.map(item => {
                const isChecked = savedData[item] ? 'checked' : '';
                return `<div class="flex items-center cursor-pointer check-item ${isChecked}" onclick="toggleCheck('${item}')"><div class="check-box">${isChecked ? 'âœ”' : ''}</div><span>${item}</span></div>`;
            }).join('');
        }
        function toggleCheck(item) {
            const savedData = JSON.parse(localStorage.getItem('packing_sg') || '{}');
            savedData[item] = !savedData[item];
            localStorage.setItem('packing_sg', JSON.stringify(savedData));
            renderPackingList();
        }
        function resetPacking() { if(confirm('é‡ç½®?')) { localStorage.removeItem('packing_sg'); renderPackingList(); } }
        function renderJapaneseCards() {
            const container = document.getElementById('jp-card-container');
            container.innerHTML = jpCards.map(c => `<div class="jp-card" onclick="alert('${c.jp}\\n(${c.ro})')"><div class="text-xs text-stone-400 font-bold mb-1">${c.ch}</div><div class="text-lg font-bold text-stone-800">${c.jp}</div><div class="text-xs text-emerald-400 mt-1">${c.ro}</div></div>`).join('');
        }
        function initWeather() {
            // Singapore Lat/Lng
            fetch("https://api.open-meteo.com/v1/forecast?latitude=1.3521&longitude=103.8198&current=temperature_2m,weather_code&timezone=Asia%2FSingapore")
            .then(res => res.json()).then(data => {
                const temp = Math.round(data.current.temperature_2m);
                let icon = "â˜ï¸"; if (data.current.weather_code === 0) icon = "â˜€ï¸";
                document.getElementById('weather-temp').innerText = temp;
                document.getElementById('weather-icon').innerText = icon;
                document.getElementById('weather-loading').style.display = 'none';
                document.getElementById('weather-display').classList.remove('opacity-0');
            }).catch(console.error);
        }
        function fetchData() {
            Papa.parse(SHEET_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) { processData(results.data); }
            });
        }
        function processData(data) {
            const raw = data.filter(row => row.day_group);
            let grandTotal = 0; const scheduleMap = new Map();
            raw.forEach(row => {
                let cost = parseInt((row.cost||"").replace(/[^0-9]/g, '')) || 0; grandTotal += cost;
                let mapUrl = row.map_url || (row.title ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(row.title)}` : "");
                let igUrl = row.instagram || "";
                if (!igUrl && row.title && !(row.type||"").toLowerCase().includes('transport')) {
                    igUrl = `https://www.instagram.com/explore/tags/${encodeURIComponent(row.title.replace(/[ .\/\\()ï¼ˆï¼‰-]/g, ''))}/`;
                }
                const item = { time: row.time||"", icon: row.icon||"ğŸ“", title: row.title||"", desc: row.desc||"", type: getType(row.type), mapUrl: mapUrl, image: row.image||"", cost: cost, day: row.day_group, igUrl: igUrl };
                if (row.date && row.date.trim() !== "") {
                    const dayKey = row.day_group.trim();
                    if (!scheduleMap.has(dayKey)) scheduleMap.set(dayKey, { day: row.day_group, date: row.date, events: [] });
                    scheduleMap.get(dayKey).events.push(item);
                    if (scheduleMap.size === 1) startCountdown(`2025/${row.date.split(' ')[0]} 00:00:00`);
                } else {
                    const listKey = row.day_group.trim();
                    if (!listData.has(listKey)) listData.set(listKey, []);
                    listData.get(listKey).push(item);
                }
            });
            scheduleData = Array.from(scheduleMap.values());
            document.getElementById('total-budget').innerText = grandTotal.toLocaleString();
            if (scheduleData.length > 0) renderScheduleMode(); else switchView('list');
        }
        function renderScheduleMode() {
            const c = document.getElementById('day-tabs'); c.innerHTML = '';
            scheduleData.forEach((d, i) => {
                const isActive = i === currentDayIndex;
                const btn = document.createElement('button');
                btn.className = `flex-none rounded-xl px-3 py-2 transition-all min-w-[4rem] flex flex-col items-center justify-center ${isActive ? 'bg-emerald-500 text-white shadow-md transform scale-105' : 'text-stone-400 hover:bg-white hover:text-stone-600'}`;
                btn.innerHTML = `<span class="text-[10px] font-bold uppercase tracking-wider opacity-80 font-display">${d.day}</span><span class="text-xs font-bold font-hand">${d.date.split(' ')[0]}</span>`;
                btn.onclick = () => { currentDayIndex = i; renderScheduleMode(); };
                c.appendChild(btn);
            });
            const container = document.getElementById('schedule-list');
            container.innerHTML = '';
            if(scheduleData.length > 0) {
                scheduleData[currentDayIndex].events.forEach((e, i) => {
                    const item = document.createElement('div');
                    item.className = "flex gap-4 items-start group opacity-0 animate-fade-in-up"; item.style.animationDelay = `${i * 50}ms`;
                    let imgHtml = e.image ? `<div class="mt-3 rounded-lg overflow-hidden h-36 w-full shadow-inner border border-stone-100 rotate-1 bg-stone-50"><img src="${e.image}" class="w-full h-full object-cover"></div>` : '';
                    let igBtn = e.igUrl ? `<button onclick="event.stopPropagation(); window.open('${e.igUrl}', '_blank')" class="ml-auto btn-instagram text-[10px] px-2.5 py-1 rounded-full font-bold flex items-center gap-1 transition-transform hover:scale-105 shadow-sm text-white"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg> Reels</button>` : '';
                    let costHtml = e.cost > 0 ? `<span class="text-[10px] font-bold text-stone-400 font-mono">NT$${e.cost.toLocaleString()}</span>` : '';
                    item.innerHTML = `<div class="flex-none w-[50px] flex flex-col items-center relative z-10"><div class="sticky top-28 flex flex-col items-center"><span class="text-xs font-hand font-bold text-stone-400 mb-1">${e.time.split(' ')[0]}</span><div class="w-10 h-10 rounded-full bg-white border-2 border-dashed border-stone-200 shadow-sm flex items-center justify-center text-lg z-10 group-hover:rotate-12 transition-transform">${e.icon}</div></div></div><div class="flex-1 journal-card p-4 hover:shadow-md transition-all cursor-pointer" onclick="window.open('${e.mapUrl}', '_blank')"><div class="washi-tape"></div><div class="flex justify-between items-start mb-1"><span class="px-2 py-0.5 rounded text-[10px] font-bold font-display ${e.type.bg} ${e.type.text}">${e.type.label}</span>${costHtml}</div><h3 class="font-bold text-stone-700 text-lg mb-1 leading-snug group-hover:text-emerald-500 transition-colors font-display">${e.title}</h3><p class="text-stone-500 text-sm leading-relaxed font-hand">${e.desc}</p>${imgHtml}<div class="mt-3 flex items-center justify-end">${igBtn}</div></div>`;
                    container.appendChild(item);
                });
            }
        }
        function renderListMode() {
            const container = document.getElementById('schedule-list'); const catContainer = document.getElementById('category-tabs'); container.innerHTML = ''; catContainer.innerHTML = ''; 
            if (listData.size === 0) return;
            listData.forEach((_, category) => {
                const btn = document.createElement('button');
                btn.className = "flex-none px-4 py-1.5 rounded-full text-sm font-hand font-bold bg-white text-stone-500 border border-stone-200 hover:bg-emerald-50 hover:text-emerald-600 transition-all shadow-sm";
                btn.innerText = category;
                btn.onclick = () => { const section = document.getElementById(`cat-${category}`); if(section) { const y = section.getBoundingClientRect().top + window.pageYOffset - 120; window.scrollTo({top: y, behavior: 'smooth'}); } };
                catContainer.appendChild(btn);
            });
            listData.forEach((items, category) => {
                const section = document.createElement('div'); section.id = `cat-${category}`; section.className = "mb-8 opacity-0 animate-fade-in-up";
                let badgeClass = "bg-stone-100 text-stone-600"; if(category.includes("ç¾é£Ÿ")) badgeClass = "bg-emerald-100 text-emerald-700"; else if(category.includes("è³¼ç‰©")) badgeClass = "bg-pink-100 text-pink-700";
                section.innerHTML = `<div class="flex items-center gap-2 mb-4 px-1 sticky top-16 z-0 pt-2 pb-1 bg-[#f0fdfa]/90 backdrop-blur-sm w-full"><span class="px-3 py-1 rounded-lg text-xs font-bold font-display ${badgeClass}">${category}</span><span class="text-xs text-stone-400 font-mono">(${items.length})</span></div><div class="grid grid-cols-2 gap-4"></div>`;
                const grid = section.querySelector('.grid');
                items.forEach((e, i) => {
                    const card = document.createElement('div');
                    const rotateDeg = (i % 2 === 0) ? '-1deg' : '1deg';
                    card.className = "polaroid-card cursor-pointer group relative"; card.style.transform = `rotate(${rotateDeg})`; card.onclick = () => window.open(e.mapUrl, '_blank');
                    let imgHtml = e.image ? `<div class="mt-2 h-24 w-full overflow-hidden border border-stone-100 bg-stone-50"><img src="${e.image}" class="w-full h-full object-cover"></div>` : '';
                    let igBtn = e.igUrl ? `<button onclick="event.stopPropagation(); window.open('${e.igUrl}', '_blank')" class="absolute top-2 right-2 btn-instagram p-1.5 rounded-full shadow-md z-10 transform scale-75 hover:scale-90 transition-transform text-white"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></button>` : '';
                    let costHtml = e.cost > 0 ? `<div class="mt-2 text-right border-t border-dashed border-stone-200 pt-1"><span class="text-[10px] font-hand font-bold text-stone-400">NT$${e.cost.toLocaleString()}</span></div>` : '';
                    card.innerHTML = `<div class="flex justify-between items-start mb-1"><span class="text-xl">${e.icon}</span>${igBtn}</div><h3 class="font-bold text-stone-700 text-sm leading-snug mb-1 font-display group-hover:text-emerald-500 line-clamp-2">${e.title}</h3>${imgHtml}${costHtml}`;
                    grid.appendChild(card);
                });
                container.appendChild(section);
            });
        }
        function getType(t) { t = (t||"").toLowerCase(); if(t.includes('trans')) return {bg:'bg-blue-50', text:'text-blue-600', label:'äº¤é€š'}; if(t.includes('food')) return {bg:'bg-emerald-50', text:'text-emerald-600', label:'ç¾é£Ÿ'}; if(t.includes('stay')) return {bg:'bg-indigo-50', text:'text-indigo-600', label:'ä½å®¿'}; return {bg:'bg-orange-50', text:'text-orange-600', label:'æ´»å‹•'}; }
        function startCountdown(dateString) { const targetDate = new Date(dateString).getTime(); setInterval(() => { const now = new Date().getTime(); const distance = targetDate - now; if (distance < 0) { document.getElementById("countdown-timer").innerText = "Trip Started!"; return; } const days = Math.floor(distance / (1000 * 60 * 60 * 24)); document.getElementById("countdown-timer").innerText = `å€’æ•¸ ${days} å¤©`; }, 1000); }
        function openDayRoute() { const events = scheduleData[currentDayIndex].events; if(!events || events.length === 0) return; let waypoints = events.filter(e => !e.type.label.includes('äº¤é€š')).map(e => encodeURIComponent(e.title)); if(waypoints.length === 0) { alert("ä»Šå¤©æ²’æœ‰å…·é«”æ™¯é»å¯å°èˆª"); return; } window.open(`https://www.google.com/maps/dir/${waypoints.join('/')}`, '_blank'); }
        const RATE = 24.7; function toggleConverter() { const costView = document.getElementById('cost-view'); const converterView = document.getElementById('converter-view'); if(costView.classList.contains('hidden')) { costView.classList.remove('hidden'); converterView.classList.add('hidden'); } else { costView.classList.add('hidden'); converterView.classList.remove('hidden'); setTimeout(() => document.getElementById('jpy-input').focus(), 100); } }
        document.getElementById('jpy-input').addEventListener('input', function(e) { document.getElementById('twd-output').innerText = Math.round((parseFloat(e.target.value) || 0) * EXCHANGE_RATE).toLocaleString(); });
    </script>
</body>
</html>