<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的旅行計畫 ✈️</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .timeline-line {
            position: absolute; left: 1rem; top: 0; bottom: 0;
            width: 2px; background-color: #e5e7eb; z-index: 0;
        }
        /* Loading 動畫 */
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <a href="../" class="fixed top-4 left-4 z-[60] bg-white/80 backdrop-blur-sm p-2 rounded-full shadow-lg hover:bg-white text-gray-700 transition-all border border-gray-200">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
    </a>

    <header class="bg-blue-600 text-white p-6 sticky top-0 z-50 shadow-md">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">東京五天四夜</h1>
            <div id="loading-status" class="loader hidden"></div>
        </div>
    </header>

    <div class="max-w-md mx-auto min-h-screen bg-white shadow-lg overflow-hidden">
        <div class="flex overflow-x-auto bg-white border-b sticky top-[76px] z-40" id="day-tabs"></div>
        <div class="p-4 relative" id="schedule-container">
            <div class="timeline-line"></div>
            <div id="schedule-list" class="space-y-6 relative z-10"></div>
        </div>
    </div>

    <script>
        // ==========================================
        //  設定區：請貼上您的 Google Sheet CSV 網址
        // ==========================================
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1a1iVFz0vn9imxeIP8xKlb8q5pttyKR3FFCo0fUEZGMc/edit?usp=sharing';

        let currentDayIndex = 0;
        let tripData = []; // 這裡現在是空的，等待資料載入

        // 初始化
        window.onload = function() {
            document.getElementById('loading-status').classList.remove('hidden');
            fetchData();
        };

        function fetchData() {
            Papa.parse(SHEET_URL, {
                download: true,
                header: true,
                complete: function(results) {
                    console.log("原始資料:", results.data);
                    processData(results.data);
                    document.getElementById('loading-status').classList.add('hidden');
                },
                error: function(err) {
                    alert("讀取資料庫失敗，請檢查 CSV 連結");
                    console.error(err);
                }
            });
        }

        // 將 Sheet 的平面資料轉換成我們需要的結構
        function processData(rawData) {
            // 過濾掉空行
            const validRows = rawData.filter(row => row.day_group && row.title);
            
            // 使用 Map 來分組
            const grouped = new Map();

            validRows.forEach(row => {
                const dayKey = row.day_group; // 例如 "Day 1"
                
                if (!grouped.has(dayKey)) {
                    grouped.set(dayKey, {
                        day: row.day_group,
                        date: row.date,
                        events: []
                    });
                }
                
                grouped.get(dayKey).events.push({
                    time: row.time,
                    icon: row.icon,
                    title: row.title,
                    desc: row.desc,
                    type: row.type
                });
            });

            // 轉回 Array
            tripData = Array.from(grouped.values());
            
            if(tripData.length > 0) {
                renderTabs();
                renderSchedule();
            } else {
                document.getElementById('schedule-list').innerHTML = '<p class="text-center p-4">目前沒有行程資料</p>';
            }
        }

        function renderTabs() {
            const tabsContainer = document.getElementById('day-tabs');
            tabsContainer.innerHTML = '';
            
            tripData.forEach((day, index) => {
                const btn = document.createElement('button');
                const isActive = index === currentDayIndex;
                btn.className = `flex-none px-6 py-3 text-sm font-medium whitespace-nowrap transition-colors ${
                    isActive ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-500 hover:text-gray-700'
                }`;
                btn.innerHTML = `<div>${day.day}</div><div class="text-xs font-normal">${day.date}</div>`;
                btn.onclick = () => {
                    currentDayIndex = index;
                    renderTabs();
                    renderSchedule();
                };
                tabsContainer.appendChild(btn);
            });
        }

        function renderSchedule() {
            const listContainer = document.getElementById('schedule-list');
            listContainer.innerHTML = '';
            const dayEvents = tripData[currentDayIndex].events;

            dayEvents.forEach(event => {
                let colorClass = "bg-white border-gray-200";
                if(event.type === 'transport') colorClass = "bg-blue-50 border-blue-200";
                if(event.type === 'food') colorClass = "bg-orange-50 border-orange-200";
                if(event.type === 'stay') colorClass = "bg-purple-50 border-purple-200";

                const item = document.createElement('div');
                item.className = "flex gap-4 items-start";
                item.innerHTML = `
                    <div class="flex-none w-8 flex flex-col items-center">
                        <div class="w-3 h-3 rounded-full bg-blue-500 ring-4 ring-white mt-1.5"></div>
                    </div>
                    <div class="flex-1 p-4 rounded-lg border shadow-sm ${colorClass}">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold text-gray-900 text-lg">${event.time}</span>
                            <span class="text-2xl">${event.icon}</span>
                        </div>
                        <h3 class="font-bold text-gray-800 text-lg mb-1">${event.title}</h3>
                        <p class="text-gray-600 text-sm leading-relaxed">${event.desc}</p>
                    </div>
                `;
                listContainer.appendChild(item);
            });
        }
    </script>
</body>
</html>